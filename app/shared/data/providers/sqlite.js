"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var sql = require("nativescript-sqlite");
core_1.Injectable();
var Sqlite = (function () {
    //https://stackoverflow.com/questions/36269197/sqlite-exception-from-delete
    function Sqlite() {
        var _this = this;
        //Queries
        this.qDbname = "abpp.db";
        this.qCreateSettingsTable = "CREATE TABLE IF NOT EXISTS settings (id INTEGER PRIMARY KEY AUTOINCREMENT, `key` VARCHAR(100), `value` TEXT)";
        this.qCreateFormsTable = "CREATE TABLE IF NOT EXISTS forms (id INTEGER PRIMARY KEY AUTOINCREMENT, form_id INTEGER, title TEXT, json TEXT, updated_at DATE DEFAULT (datetime('now','localtime')))";
        this.qCreateQueuesTable = "CREATE TABLE IF NOT EXISTS queue (id INTEGER PRIMARY KEY AUTOINCREMENT, form_id INTEGER, payload TEXT,  updated_at DATE DEFAULT (datetime('now','localtime')), status INTEGER DEFAULT 0)";
        // State in Queue
        this.PENDING_STATE = 0;
        this.PROCESSED_STATE = 1;
        //Getters
        this.qGetSetting = "SELECT * FROM settings WHERE `key`=?";
        this.qGetForm = "SELECT * FROM forms where form_id=?";
        this.qGetOneQueue = "SELECT * FROM queue WHERE form_id=?";
        this.qGetAllQueueStatus = "SELECT * FROM queue WHERE status=?";
        this.qGetAllForms = "SELECT * FROM forms";
        this.qGetAllSettings = "SELECT * FROM settings";
        this.qGetAllQueue = "SELECT * FROM queue";
        //Setters
        this.qSetSetting = "INSERT OR REPLACE INTO settings (id, `key`, `value`) VALUES ((SELECT id FROM settings WHERE `key`=?),?,?)";
        this.qSetForm = "INSERT OR REPLACE INTO forms (id, form_id, title, json) VALUES ((SELECT id FROM forms WHERE `form_id`=?),?,?,?)";
        this.qAddToQueue = "INSERT INTO queue (form_id, payload) VALUES (?,?)";
        this.qUpdateQueue = "UPDATE queue SET status=? WHERE form_id=?";
        this.qUpdateQueueById = "UPDATE queue SET status=? WHERE id=?";
        this.qClearQueue = "DELETE FROM queue WHERE 0=0";
        this.qClearForms = "DELETE FROM forms WHERE 0=0";
        this.qClearSettings = "DELETE FROM settings WHERE 0=0";
        this.qDeleteSetting = "DELETE FROM settings WHERE `key`=?";
        //DB Aanmaken + tabellen
        if (!this.isInstantiated) {
            //sql.deleteDatabase(this.qDbname);
            this.db = (new sql(this.qDbname));
            this.db.then(function (db) {
                db.execSQL(_this.qCreateSettingsTable).then(function (id) {
                }, function (error) {
                    console.error('Failed to create settings table!');
                });
                db.execSQL(_this.qCreateFormsTable).then(function (id) {
                }, function (error) {
                    console.error('Failed to create forms table!');
                });
                db.execSQL(_this.qCreateQueuesTable).then(function (id) {
                }, function (error) {
                    console.error('Failed to create queus table!');
                });
                //this.db = db;
                _this.isInstantiated = true;
            }, function (error) {
                console.error('Failed to open DB!');
            });
        }
    }
    Sqlite.prototype.getDbHandler = function () {
        return this.db;
    };
    Sqlite.prototype.setAuth = function (token_id) {
        return this.setSetting('auth', token_id);
    };
    Sqlite.prototype.getAuth = function () {
        return this.getSetting('auth');
    };
    Sqlite.prototype.clearAuth = function () {
        var _this = this;
        this.db.then(function (db) {
            db.execSQL(_this.qDeleteSetting, ['auth']).then(function () {
                return true;
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.setForm = function (form) {
        var _this = this;
        this.db.then(function (db) {
            db.execSQL(_this.qSetForm, [form.Id, form.Id, form.Title, form]).then(function (value) {
                return true;
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.getForm = function (form_id) {
        var _this = this;
        return this.db.then(function (db) {
            return db.get(_this.qGetForm, [form_id], function (err, row) {
                //row[2];
            });
        });
    };
    Sqlite.prototype.getAllForms = function () {
        var _this = this;
        return this.db.then(function (db) {
            return db.get(_this.qGetAllForms, function (err, rows) { });
        });
    };
    Sqlite.prototype.clearForms = function () {
        var _this = this;
        this.db.then(function (db) {
            console.log('clearQueue');
            db.execSQL(_this.qClearForms).then(function (rows) {
                console.log('deleted Form Rows Count = ' + rows);
                return rows;
            }, function (error) {
                console.log("DELETE ERROR", error);
            });
        });
    };
    Sqlite.prototype.getSettings = function () {
        var _this = this;
        return this.db.then(function (db) {
            return db.all(_this.qGetAllSettings).then(function (rows) {
                //console.dump(rows);
                return rows;
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.getSetting = function (key) {
        var _this = this;
        return this.db.then(function (db) {
            return db.get(_this.qGetSetting, [key], function (err, row) {
                if (err) {
                    this.errorHandler(err);
                }
            });
        });
    };
    Sqlite.prototype.setSetting = function (key, value) {
        var _this = this;
        return this.db.then(function (db) {
            return db.execSQL(_this.qSetSetting, [key, key, value]).then(function (value) {
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.setSettings = function (settings) {
        var _this = this;
        return this.db.then(function (db) {
            for (var key in settings) {
                db.execSQL(_this.qSetSetting, [key, key, settings[key]])
                    .then(function (res) { }, function (error) { return _this.errorHandler(error); });
            }
        });
    };
    Sqlite.prototype.clearSettings = function () {
        var _this = this;
        this.db.then(function (db) {
            console.log('clearQueue');
            db.execSQL(_this.qClearSettings).then(function (rows) {
                console.log('deleted Settings Rows Count = ' + rows);
                return rows;
            }, function (error) {
                console.log("DELETE ERROR", error);
            });
        });
    };
    Sqlite.prototype.addToQueue = function (form_id, payload) {
        var _this = this;
        return this.db.then(function (db) {
            return db.execSQL(_this.qAddToQueue, [form_id, payload]).then(function (id) {
                //returns ID
                console.log('added Queue Id = ' + id);
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.getOneQueue = function (queu_id) {
        var _this = this;
        return this.db.then(function (db) {
            return db.get(_this.qGetOneQueue, [queu_id], function (err, row) { });
        });
    };
    /*
    original was execSQL
    GET SQL Statement should be start with all
    like db.all
    */
    Sqlite.prototype.getQueueWithStatus = function (status) {
        var _this = this;
        return this.db.then(function (db) {
            //return db.execSQL()
            return db.all(_this.qGetAllQueueStatus, [status]).then(function (rows) {
                console.log('getQueueWithStatus');
                console.log('rows =' + JSON.stringify({
                    rows: rows
                }));
                return rows;
            }, function (error) {
                console.log("SELECT ERROR", error);
            });
        });
    };
    Sqlite.prototype.getQueue = function () {
        var _this = this;
        return this.db.then(function (db) {
            return db.get(_this.qGetAllQueue, function (err, rows) { });
        });
    };
    Sqlite.prototype.updateQueueById = function (id) {
        var _this = this;
        return this.db.then(function (db) {
            console.log('updateQueueById');
            db.execSQL(_this.qUpdateQueueById, [_this.PROCESSED_STATE, id]).then(function (rows) {
                console.log('updated Queue Rows Count = ' + rows);
                return rows;
            }, function (error) {
                console.log("UPDATE ERROR", error);
            });
        });
    };
    Sqlite.prototype.clearQueue = function () {
        var _this = this;
        this.db.then(function (db) {
            console.log('clearQueue');
            db.execSQL(_this.qClearQueue).then(function (rows) {
                console.log('deleted Queue Rows Count = ' + rows);
                return rows;
            }, function (error) {
                console.log("DELETE ERROR", error);
            });
        });
    };
    Sqlite.prototype.clearAll = function () {
        this.clearForms();
        this.clearQueue();
        this.clearSettings();
    };
    Sqlite.prototype.errorHandler = function (error) {
        console.error("DataBase Handling Error: " + error);
    };
    return Sqlite;
}());
exports.Sqlite = Sqlite;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FsaXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3FsaXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTJDO0FBRzNDLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBRXpDLGlCQUFVLEVBQUUsQ0FBQTtBQUNaO0lBb0NJLDJFQUEyRTtJQUUzRTtRQUFBLGlCQTRCQztRQTVERCxTQUFTO1FBQ0QsWUFBTyxHQUFXLFNBQVMsQ0FBQztRQUM1Qix5QkFBb0IsR0FBVyw4R0FBOEcsQ0FBQztRQUM5SSxzQkFBaUIsR0FBVyx3S0FBd0ssQ0FBQztRQUNyTSx1QkFBa0IsR0FBVywwTEFBMEwsQ0FBQztRQUVoTyxpQkFBaUI7UUFDVCxrQkFBYSxHQUFHLENBQUMsQ0FBQztRQUNsQixvQkFBZSxHQUFHLENBQUMsQ0FBQztRQUU1QixTQUFTO1FBQ0QsZ0JBQVcsR0FBRyxzQ0FBc0MsQ0FBQztRQUNyRCxhQUFRLEdBQUcscUNBQXFDLENBQUM7UUFDakQsaUJBQVksR0FBRyxxQ0FBcUMsQ0FBQztRQUNyRCx1QkFBa0IsR0FBRyxvQ0FBb0MsQ0FBQztRQUMxRCxpQkFBWSxHQUFHLHFCQUFxQixDQUFDO1FBQ3JDLG9CQUFlLEdBQUcsd0JBQXdCLENBQUM7UUFDM0MsaUJBQVksR0FBRyxxQkFBcUIsQ0FBQztRQUU3QyxTQUFTO1FBQ0QsZ0JBQVcsR0FBRywyR0FBMkcsQ0FBQztRQUMxSCxhQUFRLEdBQUcsaUhBQWlILENBQUM7UUFDN0gsZ0JBQVcsR0FBRyxtREFBbUQsQ0FBQztRQUNsRSxpQkFBWSxHQUFHLDJDQUEyQyxDQUFDO1FBQzNELHFCQUFnQixHQUFHLHNDQUFzQyxDQUFDO1FBQzFELGdCQUFXLEdBQUcsNkJBQTZCLENBQUM7UUFDNUMsZ0JBQVcsR0FBRyw2QkFBNkIsQ0FBQztRQUM1QyxtQkFBYyxHQUFHLGdDQUFnQyxDQUFDO1FBQ2xELG1CQUFjLEdBQUcsb0NBQW9DLENBQUM7UUFLMUQsd0JB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VUFBQSxFQUFFO1lBQ1gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMxQixFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxJQUFJO2dCQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixHQUFHLElBQUksQ0FBQyxDQUFBO2dCQUNqRCxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ2hCLENBQUMsRUFDRCxVQUFDLEtBQUs7Z0JBQ0YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCx5QkFBUSxHQUFSO1FBQ0ksSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVELDZCQUFZLEdBQVosVUFBYSxLQUFLO1FBQ2QsT0FBTyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsR0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBQ0wsYUFBQztBQUFELENBQUMsQUEvUEQsSUErUEM7QUEvUFksd0JBQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tIFwiLi4vcmVwb3NpdG9yeVwiO1xuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSBcIi4uLy4uL0NvbmZpZ1wiO1xudmFyIHNxbCA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtc3FsaXRlXCIpO1xuXG5JbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTcWxpdGUgaW1wbGVtZW50cyBSZXBvc2l0b3J5IHtcbiAgICBcbiAgICBwcml2YXRlIGRiOiBhbnk7IC8vREIgSGFuZGxlclxuICAgIHByaXZhdGUgYXV0aFRva2VuOiBhbnk7XG4gICAgcHJpdmF0ZSBpc0luc3RhbnRpYXRlZDogYm9vbGVhbjsgLy9TaW5nbGV0b24gc3R5bGVcblxuICAgIC8vUXVlcmllc1xuICAgIHByaXZhdGUgcURibmFtZTogc3RyaW5nID0gXCJhYnBwLmRiXCI7XG4gICAgcHJpdmF0ZSBxQ3JlYXRlU2V0dGluZ3NUYWJsZTogc3RyaW5nID0gXCJDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBzZXR0aW5ncyAoaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULCBga2V5YCBWQVJDSEFSKDEwMCksIGB2YWx1ZWAgVEVYVClcIjtcbiAgICBwcml2YXRlIHFDcmVhdGVGb3Jtc1RhYmxlOiBzdHJpbmcgPSBcIkNSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGZvcm1zIChpZCBJTlRFR0VSIFBSSU1BUlkgS0VZIEFVVE9JTkNSRU1FTlQsIGZvcm1faWQgSU5URUdFUiwgdGl0bGUgVEVYVCwganNvbiBURVhULCB1cGRhdGVkX2F0IERBVEUgREVGQVVMVCAoZGF0ZXRpbWUoJ25vdycsJ2xvY2FsdGltZScpKSlcIjtcbiAgICBwcml2YXRlIHFDcmVhdGVRdWV1ZXNUYWJsZTogc3RyaW5nID0gXCJDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBxdWV1ZSAoaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULCBmb3JtX2lkIElOVEVHRVIsIHBheWxvYWQgVEVYVCwgIHVwZGF0ZWRfYXQgREFURSBERUZBVUxUIChkYXRldGltZSgnbm93JywnbG9jYWx0aW1lJykpLCBzdGF0dXMgSU5URUdFUiBERUZBVUxUIDApXCI7XG5cbiAgICAvLyBTdGF0ZSBpbiBRdWV1ZVxuICAgIHByaXZhdGUgUEVORElOR19TVEFURSA9IDA7XG4gICAgcHJpdmF0ZSBQUk9DRVNTRURfU1RBVEUgPSAxO1xuXG4gICAgLy9HZXR0ZXJzXG4gICAgcHJpdmF0ZSBxR2V0U2V0dGluZyA9IFwiU0VMRUNUICogRlJPTSBzZXR0aW5ncyBXSEVSRSBga2V5YD0/XCI7XG4gICAgcHJpdmF0ZSBxR2V0Rm9ybSA9IFwiU0VMRUNUICogRlJPTSBmb3JtcyB3aGVyZSBmb3JtX2lkPT9cIjtcbiAgICBwcml2YXRlIHFHZXRPbmVRdWV1ZSA9IFwiU0VMRUNUICogRlJPTSBxdWV1ZSBXSEVSRSBmb3JtX2lkPT9cIjtcbiAgICBwcml2YXRlIHFHZXRBbGxRdWV1ZVN0YXR1cyA9IFwiU0VMRUNUICogRlJPTSBxdWV1ZSBXSEVSRSBzdGF0dXM9P1wiO1xuICAgIHByaXZhdGUgcUdldEFsbEZvcm1zID0gXCJTRUxFQ1QgKiBGUk9NIGZvcm1zXCI7XG4gICAgcHJpdmF0ZSBxR2V0QWxsU2V0dGluZ3MgPSBcIlNFTEVDVCAqIEZST00gc2V0dGluZ3NcIjtcbiAgICBwcml2YXRlIHFHZXRBbGxRdWV1ZSA9IFwiU0VMRUNUICogRlJPTSBxdWV1ZVwiO1xuXG4gICAgLy9TZXR0ZXJzXG4gICAgcHJpdmF0ZSBxU2V0U2V0dGluZyA9IFwiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBzZXR0aW5ncyAoaWQsIGBrZXlgLCBgdmFsdWVgKSBWQUxVRVMgKChTRUxFQ1QgaWQgRlJPTSBzZXR0aW5ncyBXSEVSRSBga2V5YD0/KSw/LD8pXCI7XG4gICAgcHJpdmF0ZSBxU2V0Rm9ybSA9IFwiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBmb3JtcyAoaWQsIGZvcm1faWQsIHRpdGxlLCBqc29uKSBWQUxVRVMgKChTRUxFQ1QgaWQgRlJPTSBmb3JtcyBXSEVSRSBgZm9ybV9pZGA9PyksPyw/LD8pXCI7XG4gICAgcHJpdmF0ZSBxQWRkVG9RdWV1ZSA9IFwiSU5TRVJUIElOVE8gcXVldWUgKGZvcm1faWQsIHBheWxvYWQpIFZBTFVFUyAoPyw/KVwiO1xuICAgIHByaXZhdGUgcVVwZGF0ZVF1ZXVlID0gXCJVUERBVEUgcXVldWUgU0VUIHN0YXR1cz0/IFdIRVJFIGZvcm1faWQ9P1wiO1xuICAgIHByaXZhdGUgcVVwZGF0ZVF1ZXVlQnlJZCA9IFwiVVBEQVRFIHF1ZXVlIFNFVCBzdGF0dXM9PyBXSEVSRSBpZD0/XCI7XG4gICAgcHJpdmF0ZSBxQ2xlYXJRdWV1ZSA9IFwiREVMRVRFIEZST00gcXVldWUgV0hFUkUgMD0wXCI7XG4gICAgcHJpdmF0ZSBxQ2xlYXJGb3JtcyA9IFwiREVMRVRFIEZST00gZm9ybXMgV0hFUkUgMD0wXCI7XG4gICAgcHJpdmF0ZSBxQ2xlYXJTZXR0aW5ncyA9IFwiREVMRVRFIEZST00gc2V0dGluZ3MgV0hFUkUgMD0wXCI7XG4gICAgcHJpdmF0ZSBxRGVsZXRlU2V0dGluZyA9IFwiREVMRVRFIEZST00gc2V0dGluZ3MgV0hFUkUgYGtleWA9P1wiO1xuXG4gICAgLy9odHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zNjI2OTE5Ny9zcWxpdGUtZXhjZXB0aW9uLWZyb20tZGVsZXRlXG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IoKXtcbiAgICAgICAgLy9EQiBBYW5tYWtlbiArIHRhYmVsbGVuXG4gICAgICAgIGlmKCF0aGlzLmlzSW5zdGFudGlhdGVkKXtcbiAgICAgICAgICAgIC8vc3FsLmRlbGV0ZURhdGFiYXNlKHRoaXMucURibmFtZSk7XG4gICAgICAgICAgICB0aGlzLmRiID0gKG5ldyBzcWwodGhpcy5xRGJuYW1lKSk7XG4gICAgICAgICAgICB0aGlzLmRiLnRoZW4oZGI9PnsgXG4gICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFDcmVhdGVTZXR0aW5nc1RhYmxlKS50aGVuKGlkPT57XG4gICAgICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gY3JlYXRlIHNldHRpbmdzIHRhYmxlIScpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFDcmVhdGVGb3Jtc1RhYmxlKS50aGVuKGlkPT57XG4gICAgICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gY3JlYXRlIGZvcm1zIHRhYmxlIScpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFDcmVhdGVRdWV1ZXNUYWJsZSkudGhlbihpZD0+e1xuICAgICAgICAgICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGNyZWF0ZSBxdWV1cyB0YWJsZSEnKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8vdGhpcy5kYiA9IGRiO1xuICAgICAgICAgICAgICAgIHRoaXMuaXNJbnN0YW50aWF0ZWQgPSB0cnVlO1xuXG4gICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIG9wZW4gREIhJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldERiSGFuZGxlcigpe1xuICAgICAgICByZXR1cm4gdGhpcy5kYjtcbiAgICB9XG5cbiAgICBzZXRBdXRoKHRva2VuX2lkKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0U2V0dGluZygnYXV0aCcsdG9rZW5faWQpO1xuICAgIH1cblxuICAgIGdldEF1dGgoKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2V0dGluZygnYXV0aCcpO1xuICAgIH1cblxuICAgIGNsZWFyQXV0aCgpe1xuICAgICAgICB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIGRiLmV4ZWNTUUwodGhpcy5xRGVsZXRlU2V0dGluZyxbJ2F1dGgnXSkudGhlbigoKT0+e1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4gdGhpcy5lcnJvckhhbmRsZXIoZXJyb3IpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc2V0Rm9ybShmb3JtKXtcbiAgICAgICAgdGhpcy5kYi50aGVuKGRiPT57XG4gICAgICAgICAgICBkYi5leGVjU1FMKHRoaXMucVNldEZvcm0sW2Zvcm0uSWQsIGZvcm0uSWQsZm9ybS5UaXRsZSxmb3JtXSkudGhlbih2YWx1ZT0+e1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4gdGhpcy5lcnJvckhhbmRsZXIoZXJyb3IpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0Rm9ybShmb3JtX2lkKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgcmV0dXJuIGRiLmdldCh0aGlzLnFHZXRGb3JtLFtmb3JtX2lkXSwgZnVuY3Rpb24oZXJyLHJvdyl7XG4gICAgICAgICAgICAgICAgLy9yb3dbMl07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0QWxsRm9ybXMoKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgcmV0dXJuIGRiLmdldCh0aGlzLnFHZXRBbGxGb3JtcyxmdW5jdGlvbihlcnIscm93cyl7fSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNsZWFyRm9ybXMoKXtcbiAgICAgICAgdGhpcy5kYi50aGVuKGRiPT57XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnY2xlYXJRdWV1ZScpO1xuICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFDbGVhckZvcm1zKS50aGVuKChyb3dzKT0+e1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdkZWxldGVkIEZvcm0gUm93cyBDb3VudCA9ICcgKyByb3dzKVxuICAgICAgICAgICAgICAgIHJldHVybiByb3dzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChlcnJvcik9PntcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRFTEVURSBFUlJPUlwiLCBlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0U2V0dGluZ3MoKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgcmV0dXJuIGRiLmFsbCh0aGlzLnFHZXRBbGxTZXR0aW5ncykudGhlbihyb3dzPT57XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmR1bXAocm93cyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJvd3M7XG4gICAgICAgICAgICB9LCBlcnJvciA9PiB0aGlzLmVycm9ySGFuZGxlcihlcnJvcikgKTtcbiAgICAgICAgfSk7XG4gICAgfSBcblxuXG4gICAgZ2V0U2V0dGluZyhrZXkpe1xuICAgICAgICByZXR1cm4gdGhpcy5kYi50aGVuKGRiPT57XG4gICAgICAgICAgICByZXR1cm4gZGIuZ2V0KHRoaXMucUdldFNldHRpbmcsW2tleV0sIGZ1bmN0aW9uKGVycixyb3cpe1xuICAgICAgICAgICAgICAgIGlmKGVycil7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyKGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHNldFNldHRpbmcoa2V5LCB2YWx1ZSl7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIHJldHVybiBkYi5leGVjU1FMKHRoaXMucVNldFNldHRpbmcsW2tleSwga2V5LHZhbHVlXSkudGhlbih2YWx1ZT0+e1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4gdGhpcy5lcnJvckhhbmRsZXIoZXJyb3IpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc2V0U2V0dGluZ3Moc2V0dGluZ3Mpe1xuICAgICAgICByZXR1cm4gdGhpcy5kYi50aGVuKGRiPT57XG4gICAgICAgICAgICBmb3IobGV0IGtleSBpbiBzZXR0aW5ncyl7XG4gICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFTZXRTZXR0aW5nLFtrZXksIGtleSwgc2V0dGluZ3Nba2V5XV0pXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzPT57fSwgZXJyb3IgPT4gdGhpcy5lcnJvckhhbmRsZXIoZXJyb3IpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY2xlYXJTZXR0aW5ncygpe1xuICAgICAgICB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjbGVhclF1ZXVlJyk7XG4gICAgICAgICAgICBkYi5leGVjU1FMKHRoaXMucUNsZWFyU2V0dGluZ3MpLnRoZW4oKHJvd3MpPT57XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2RlbGV0ZWQgU2V0dGluZ3MgUm93cyBDb3VudCA9ICcgKyByb3dzKVxuICAgICAgICAgICAgICAgIHJldHVybiByb3dzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChlcnJvcik9PntcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRFTEVURSBFUlJPUlwiLCBlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYWRkVG9RdWV1ZShmb3JtX2lkLCBwYXlsb2FkKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgcmV0dXJuIGRiLmV4ZWNTUUwodGhpcy5xQWRkVG9RdWV1ZSxbZm9ybV9pZCwgcGF5bG9hZF0pLnRoZW4oaWQ9PntcbiAgICAgICAgICAgICAgICAvL3JldHVybnMgSURcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYWRkZWQgUXVldWUgSWQgPSAnICtpZCk7XG4gICAgICAgICAgICB9LCBlcnJvciA9PiB0aGlzLmVycm9ySGFuZGxlcihlcnJvcikpO1xuICAgICAgICB9KTtcbiAgICAgICBcbiAgICB9XG5cbiAgICBnZXRPbmVRdWV1ZShxdWV1X2lkKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgcmV0dXJuIGRiLmdldChcbiAgICAgICAgICAgICAgICB0aGlzLnFHZXRPbmVRdWV1ZSxbcXVldV9pZF0sXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24oZXJyLHJvdyl7fVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qXG4gICAgb3JpZ2luYWwgd2FzIGV4ZWNTUUxcbiAgICBHRVQgU1FMIFN0YXRlbWVudCBzaG91bGQgYmUgc3RhcnQgd2l0aCBhbGxcbiAgICBsaWtlIGRiLmFsbFxuICAgICovXG4gICAgZ2V0UXVldWVXaXRoU3RhdHVzKHN0YXR1cyl7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIC8vcmV0dXJuIGRiLmV4ZWNTUUwoKVxuICAgICAgICAgICAgcmV0dXJuIGRiLmFsbChcbiAgICAgICAgICAgICAgICB0aGlzLnFHZXRBbGxRdWV1ZVN0YXR1cyxbc3RhdHVzXSkudGhlbihcbiAgICAgICAgICAgICAgICByb3dzPT57XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdnZXRRdWV1ZVdpdGhTdGF0dXMnKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3Jvd3MgPScgKyBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJvd3M6cm93c1xuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcm93cztcbiAgICAgICAgICAgICAgICB9LCBlcnJvciA9PntcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJTRUxFQ1QgRVJST1JcIiwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0pOyBcbiAgICAgICAgfSk7IFxuICAgIH1cblxuICAgIGdldFF1ZXVlKCl7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIHJldHVybiBkYi5nZXQoXG4gICAgICAgICAgICAgICAgdGhpcy5xR2V0QWxsUXVldWUsIFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVycixyb3dzKXt9XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB1cGRhdGVRdWV1ZUJ5SWQoaWQpe1xuICAgICAgICByZXR1cm4gdGhpcy5kYi50aGVuKGRiPT57XG4gICAgICAgICAgICBjb25zb2xlLmxvZygndXBkYXRlUXVldWVCeUlkJyk7XG4gICAgICAgICAgICBkYi5leGVjU1FMKHRoaXMucVVwZGF0ZVF1ZXVlQnlJZCwgW3RoaXMuUFJPQ0VTU0VEX1NUQVRFLGlkXSkudGhlbigocm93cyk9PntcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygndXBkYXRlZCBRdWV1ZSBSb3dzIENvdW50ID0gJyArIHJvd3MpXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJvd3M7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGVycm9yKT0+e1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVVBEQVRFIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgY2xlYXJRdWV1ZSgpe1xuICAgICAgICB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjbGVhclF1ZXVlJyk7XG4gICAgICAgICAgICBkYi5leGVjU1FMKHRoaXMucUNsZWFyUXVldWUpLnRoZW4oKHJvd3MpPT57XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2RlbGV0ZWQgUXVldWUgUm93cyBDb3VudCA9ICcgKyByb3dzKVxuICAgICAgICAgICAgICAgIHJldHVybiByb3dzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChlcnJvcik9PntcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRFTEVURSBFUlJPUlwiLCBlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSBcblxuICAgIGNsZWFyQWxsKCl7XG4gICAgICAgIHRoaXMuY2xlYXJGb3JtcygpO1xuICAgICAgICB0aGlzLmNsZWFyUXVldWUoKTtcbiAgICAgICAgdGhpcy5jbGVhclNldHRpbmdzKCk7XG4gICAgfVxuXG4gICAgZXJyb3JIYW5kbGVyKGVycm9yKXtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkRhdGFCYXNlIEhhbmRsaW5nIEVycm9yOiBcIitlcnJvcik7XG4gICAgfVxufSJdfQ==